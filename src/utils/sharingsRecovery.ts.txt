/**
 * Sharings Recovery Utility
 * Eksik sharings verilerini localStorage'dan kurtarÄ±r
 */

export interface SharingRecord {
  id: string;
  musteri_id: string;
  banka_id: string;
  pf_id: string;
  created_at?: string;
  updated_at?: string;
  is_deleted?: boolean;
}

/**
 * LocalStorage'dan sharings verilerini okur
 */
export function recoverSharingsFromLocalStorage(): SharingRecord[] {
  try {
    const sharingsData = localStorage.getItem('sharings');
    if (!sharingsData) {
      console.warn('âš ï¸ LocalStorage\'da sharings verisi bulunamadÄ±');
      return [];
    }

    const parsed = JSON.parse(sharingsData);
    console.log(`âœ… ${parsed.length} adet sharing kaydÄ± localStorage'dan okundu`);
    return parsed;
  } catch (error) {
    console.error('âŒ LocalStorage sharings okuma hatasÄ±:', error);
    return [];
  }
}

/**
 * Sharings verilerini temizler ve doÄŸrular
 */
export function validateSharings(sharings: SharingRecord[]): SharingRecord[] {
  return sharings.filter((sharing) => {
    // Gerekli alanlarÄ± kontrol et
    if (!sharing.musteri_id || !sharing.banka_id || !sharing.pf_id) {
      console.warn('âš ï¸ Eksik veri:', sharing);
      return false;
    }

    // Soft delete kontrolÃ¼
    if (sharing.is_deleted === true) {
      return false;
    }

    return true;
  });
}

/**
 * Sharings verilerini Supabase formatÄ±na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼r
 */
export function convertToSupabaseFormat(sharings: SharingRecord[]): any[] {
  return sharings.map((sharing) => ({
    id: sharing.id || crypto.randomUUID(),
    musteri_id: sharing.musteri_id,
    banka_id: sharing.banka_id,
    pf_id: sharing.pf_id,
    created_at: sharing.created_at || new Date().toISOString(),
    updated_at: sharing.updated_at || new Date().toISOString(),
    is_deleted: false,
  }));
}

/**
 * Ana kurtarma fonksiyonu
 */
export function performSharingsRecovery(): any[] {
  console.log('ğŸ”„ Sharings kurtarma iÅŸlemi baÅŸlatÄ±lÄ±yor...');

  const rawData = recoverSharingsFromLocalStorage();
  const validData = validateSharings(rawData);
  const supabaseData = convertToSupabaseFormat(validData);

  console.log(`âœ… ${supabaseData.length} adet sharing kaydÄ± kurtarÄ±ldÄ±`);
  return supabaseData;
}